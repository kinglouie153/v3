<FULL WORKING CODE FROM EARLIER>